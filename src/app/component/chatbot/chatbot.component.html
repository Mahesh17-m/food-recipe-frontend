<!-- Floating Chat Button -->
<button class="chatbot-floating-btn" (click)="toggleChat()" [class.open]="isOpen">
  <svg class="chat-icon" width="24" height="24" viewBox="0 0 24 24">
    <path [attr.d]="isOpen ? 'M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z' : 'M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17l-.59.59-.58.58V4h16v12z'"/>
  </svg>
</button>

<!-- Chat Window -->
<div class="chatbot-container" [class.open]="isOpen">
  <!-- Header -->
  <div class="chatbot-header">
    <div class="header-content">
      <div class="avatar">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="white">
          <path d="M8.1,13.34L3.91,9.16C2.35,7.59,2.35,5.06,3.91,3.5l0,0C5.48,1.94,8,1.94,9.56,3.5l4.95,4.95l1.41-1.41l-4.95-4.95C9.85,0.88,8.15,0.88,6.99,1.99L6.99,1.99C5.83,3.16,5.83,5.08,6.99,6.24l4.24,4.24l1.41-1.41L8.4,4.83c-0.78-0.78-0.78-2.05,0-2.83c0.78-0.78,2.05-0.78,2.83,0l5.66,5.66c0.78,0.78,0.78,2.05,0,2.83l0,0c-0.78,0.78-2.05,0.78-2.83,0l-3.54-3.54l-1.41,1.41l3.54,3.54c1.56,1.56,4.1,1.56,5.66,0l0,0c1.56-1.56,1.56-4.1,0-5.66L13.41,1.41c-1.56-1.56-4.1-1.56-5.66,0l0,0C6.19,2.97,6.19,5.5,7.75,7.07l4.24,4.24l1.41-1.41L9.16,5.66c-0.78-0.78-2.05-0.78-2.83,0c-0.78,0.78-0.78,2.05,0,2.83l4.95,4.95L8.1,13.34z"/>
        </svg>
      </div>
      <div class="header-text">
        <h3>Food Assistant</h3>
        <p>Ask about recipes, meal plans, or cooking tips</p>
      </div>
    </div>
    <button class="btn-clear" (click)="clearChat()" title="Clear chat">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="white">
        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
      </svg>
    </button>
  </div>

  <!-- Messages Area -->
  <div class="chatbot-messages" #messageContainer>
    @for (message of messages; track $index) {
      <div [class.user-message]="message.sender === 'user'"
           [class.bot-message]="message.sender === 'bot'"
           class="message">
        
        <div class="message-avatar">
          @if (message.sender === 'user') {
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
            </svg>
          }
          @if (message.sender === 'bot') {
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
            </svg>
          }
        </div>
        
        <div class="message-content">
          <div class="message-text">{{message.text}}</div>
          
          <!-- Recipe Suggestions -->
          @if (message.type === 'recipes' && message.data?.length) {
            <div class="recipe-suggestions">
              <p class="suggestion-title">
                <svg class="icon-small" width="16" height="16" viewBox="0 0 24 24">
                  <path d="M8.1 13.34l2.83-2.83L3.91 3.5c-1.56-1.56-1.56-4.09 0-5.66 1.56-1.56 4.09-1.56 5.66 0l7.07 7.07c1.56 1.56 1.56 4.09 0 5.66l-4.24 4.24c-1.56 1.56-4.09 1.56-5.66 0L8.1 13.34z"/>
                </svg>
                Suggested Recipes:
              </p>
              <div class="recipe-cards">
                @for (recipe of message.data; track recipe.id) {
                  <div class="recipe-card" (click)="viewRecipe(recipe.id)">
                    <div class="recipe-card-content">
                      <h5>{{recipe.title}}</h5>
                      <p>{{recipe.description}}</p>
                      <div class="recipe-meta">
                        <span>
                          <svg class="icon-xs" width="12" height="12" viewBox="0 0 24 24">
                            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zM12 20c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8zM12.5 7H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/>
                          </svg>
                          {{recipe.prepTime + recipe.cookTime}} min
                        </span>
                        <span>{{recipe.difficulty}}</span>
                        <span>
                          <svg class="icon-xs" width="12" height="12" viewBox="0 0 24 24">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                          </svg>
                          {{recipe.rating || 'New'}}
                        </span>
                      </div>
                    </div>
                    <button class="view-recipe-btn">
                      <svg width="14" height="14" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                      </svg>
                    </button>
                  </div>
                }
              </div>
            </div>
          }
          
          <div class="message-time">{{message.timestamp | date:'shortTime'}}</div>
        </div>
      </div>
    }
    
    <!-- Typing Indicator -->
    @if (isProcessing) {
      <div class="typing-indicator">
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <p>Food Assistant is thinking...</p>
      </div>
    }
  </div>

  <!-- Quick Prompts -->
  @if (!isProcessing && messages.length < 10) {
    <div class="quick-prompts">
      <p>Try asking:</p>
      <div class="prompt-buttons">
        @for (prompt of quickPrompts; track prompt.text) {
          <button (click)="useQuickPrompt(prompt.text)"
                  class="prompt-btn">
            <svg class="prompt-icon" width="16" height="16" viewBox="0 0 24 24">
              <path [attr.d]="getIcon(prompt.icon)"/>
            </svg>
            {{prompt.text}}
          </button>
        }
      </div>
    </div>
  }

  <!-- Input Area -->
  <div class="chatbot-input">
    <div class="input-wrapper">
      <textarea [(ngModel)]="chatForm.controls['message'].value"
                (keydown)="onEnterKey($event)"
                placeholder="Ask about recipes, meal plans, or cooking tips..."
                [disabled]="isProcessing"
                rows="1"
                #messageInput></textarea>
      
      <div class="input-buttons">
        <!-- Voice Button -->
        @if (isSpeechSupported) {
          <button (click)="toggleVoiceInput()"
                  [class.listening]="isListening"
                  class="voice-btn"
                  [disabled]="isProcessing">
            @if (isListening) {
              <svg width="18" height="18" viewBox="0 0 24 24">
                <path d="M0 0h24v24H0z" fill="none"/>
                <rect x="6" y="6" width="12" height="12"/>
              </svg>
            } @else {
              <svg width="18" height="18" viewBox="0 0 24 24">
                <path d="M12 15c1.66 0 2.99-1.34 2.99-3L15 6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 15 6.7 12H5c0 3.41 2.72 6.23 6 6.72V22h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
              </svg>
            }
          </button>
        }
        
        <!-- Send Button -->
        <button (click)="sendMessage()"
                [disabled]="!chatForm.value.message?.trim() || isProcessing"
                class="send-btn">
          @if (isProcessing) {
            <svg class="spin" width="20" height="20" viewBox="0 0 24 24">
              <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
            </svg>
          } @else {
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          }
        </button>
      </div>
    </div>
  </div>
</div>